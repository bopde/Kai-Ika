<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Kai Ika – Daily Operations Report</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- React -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-slate-100">
<div id="root"></div>

<script type="text/babel">
const { useState, useEffect } = React;

/* ---------------- CONSTANTS ---------------- */

const LOGO_URL =
  "https://raw.githubusercontent.com/bopde/Kai-Ika-report/main/KAI-IKA_log_white-on-trans01.png";

const PRODUCTS = [
  "Blue Nose (Lg)","Blue Nose (Sml)","Coke","Coke Zero","Crispy Batter",
  "Donation","Gurnard","Hapuku (Lg)","Hapuku (Sml)","John Dory","Kahawai",
  "Tee Shirt","King Fillet","King Steaked","Knife - Gill & Gut",
  "Knife - Set","Knife - Filleting","Knife - Skinning",
  "Knife - Steaking","L&P","Mackeral","Mahi","Marlin (Lg)",
  "Marlin (Sml)","Panko batter","Shake n Bake batter","Knife sharpening",
  "Sistema 3.8L","Snapper","SNA Scale & Fillet","SNA Scale Gut & Gill",
  "SNA Scale only","Sprite","Tarakihi","Tempura Batter","Trevally",
  "Tuna (Lg)","Tuna (Med)","Tuna (Sml)"
];

const STAFF = ["Ben","Connor","Dave","Opu","Matt","Jay"];
const TASKS = ["Filleting","Distributions","Scotts","Cans","Other"];

const DISTRIBUTION_LOCATIONS = [
  "Local School",
  "Community Center",
  "Food Bank",
  "Marae",
  "Church",
  "Youth Center",
  "Senior Center"
];

const CANS_LOCATIONS = [
  "Depot A",
  "Depot B",
  "Main Depot",
  "Recycling Center"
];

/* ---------------- APP ---------------- */

function App() {
  const today = new Date().toISOString().slice(0,10);

  const [webAppUrl, setWebAppUrl] = useState(
    localStorage.getItem("opsWebAppUrl") || ""
  );
  const [configured, setConfigured] = useState(!!webAppUrl);

  const [rows, setRows] = useState(() => {
    const saved = localStorage.getItem("kaiIkaOpsReport");
    if (saved) return JSON.parse(saved);

    return [{
      rowType: "DAY",
      date: today,
      completedBy: "",
      timestamp: new Date().toISOString()
    }];
  });

  const [loading, setLoading] = useState(false);
  const [success, setSuccess] = useState(false);

  /* -------- AUTOSAVE -------- */

  useEffect(() => {
    localStorage.setItem("kaiIkaOpsReport", JSON.stringify(rows));
  }, [rows]);

  useEffect(() => {
    if (success) {
      const t = setTimeout(() => setSuccess(false), 8000);
      return () => clearTimeout(t);
    }
  }, [success]);

  /* -------- HELPERS -------- */

  const updateRow = (i, field, value) => {
    const copy = [...rows];
    copy[i][field] = value;
    setRows(copy);
  };

  const removeRow = i => {
    if (rows[i].rowType === "DAY") return;
    setRows(rows.filter((_, idx) => idx !== i));
  };

  const addRow = type => {
    if (type === "STAFF") {
      setRows([...rows, {
        rowType:"STAFF",
        staffName:"",
        task:"Filleting",
        startTime:"",
        endTime:""
      }]);
    }
    if (type === "SALES") {
      setRows([...rows, { rowType:"SALES", totalSales:"" }]);
    }
    if (type === "PRODUCT") {
      setRows([...rows, { rowType:"PRODUCT", productName:"", quantity:"" }]);
    }
    if (type === "DISTRIBUTION") {
      setRows([...rows, { rowType:"DISTRIBUTION", binsDistributed:"", distributionTo:"" }]);
    }
    if (type === "CANS") {
      setRows([...rows, { rowType:"CANS", cansKg:"", cansLocation:"" }]);
    }
  };

  /* -------- SUBMIT -------- */

  const submit = async e => {
    e.preventDefault();
    setLoading(true);

    try {
      const fd = new FormData();

      rows.forEach(r => {
        fd.append("Row Type", r.rowType || "");
        fd.append("Date", r.date || "");
        fd.append("Form Completed By", r.completedBy || "");
        fd.append("Submission Timestamp", r.timestamp || "");

        fd.append("Staff Name", r.staffName || "");
        fd.append("Task", r.task || "");
        fd.append("Start Time", r.startTime || "");
        fd.append("End Time", r.endTime || "");

        fd.append("Product Name", r.productName || "");
        fd.append("Quantity Sold", r.quantity || "");
        fd.append("Total Sales", r.totalSales || "");

        fd.append("Bins Distributed", r.binsDistributed || "");
        fd.append("Distribution To", r.distributionTo || "");

        fd.append("Cans KG", r.cansKg || "");
        fd.append("Cans Location", r.cansLocation || "");
      });

      const res = await fetch(webAppUrl, { method:"POST", body:fd });
      const json = await res.json();
      if (!json.success) throw new Error(json.error);

      setSuccess(true);
      localStorage.removeItem("kaiIkaOpsReport");

      setRows([{
        rowType:"DAY",
        date: today,
        completedBy:"",
        timestamp:new Date().toISOString()
      }]);

    } catch (err) {
      alert(err.message);
    } finally {
      setLoading(false);
    }
  };

  /* -------- SETUP -------- */

  if (!configured) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <div className="bg-white p-6 rounded shadow w-full max-w-md">
          <h1 className="text-xl font-bold mb-4">Initial Setup</h1>
          <input
            className="w-full border p-2 rounded mb-4"
            placeholder="Apps Script Web App URL"
            value={webAppUrl}
            onChange={e=>setWebAppUrl(e.target.value)}
          />
          <button
            className="w-full bg-rose-800 text-white py-2 rounded"
            onClick={()=>{
              localStorage.setItem("opsWebAppUrl", webAppUrl);
              setConfigured(true);
            }}
          >
            Save & Continue
          </button>
        </div>
      </div>
    );
  }

  /* -------- UI -------- */

  const hasSales = rows.some(r => r.rowType === "SALES" || r.rowType === "PRODUCT");
  const hasStaff = rows.some(r => r.rowType === "STAFF");
  const hasDistributions = rows.some(r => r.rowType === "DISTRIBUTION");
  const hasCans = rows.some(r => r.rowType === "CANS");

  return (
    <>
      {/* HEADER */}
      <header className="bg-rose-900 text-white py-4 px-6 shadow">
        <div className="max-w-5xl mx-auto flex items-center gap-4">
          <img src={LOGO_URL} className="h-10" />
          <h1 className="text-2xl font-semibold tracking-wide">
            Kai Ika Daily Operations Report
          </h1>
        </div>
      </header>

      {/* SUCCESS */}
      {success && (
        <div
          onClick={()=>setSuccess(false)}
          className="fixed top-4 right-4 bg-green-600 text-white px-4 py-3 rounded shadow cursor-pointer z-50"
        >
          ✓ Report submitted successfully
        </div>
      )}

      <main className="max-w-5xl mx-auto p-4 space-y-4">

        <form onSubmit={submit} className="space-y-4">

          {/* DAY */}
          {rows.map((r,i)=>r.rowType==="DAY" && (
            <div key={i} className="bg-slate-200 p-4 rounded space-y-2">
              <div className="grid md:grid-cols-2 gap-2">
                <input type="date" className="p-2 rounded border"
                  value={r.date}
                  onChange={e=>updateRow(i,"date",e.target.value)}
                />
                <input className="p-2 rounded border"
                  placeholder="Form completed by"
                  value={r.completedBy}
                  onChange={e=>updateRow(i,"completedBy",e.target.value)}
                />
              </div>
            </div>
          ))}

          {/* ACTION BUTTONS */}
          <div className="flex flex-wrap gap-2">
            <button type="button"
              className="bg-rose-800 text-white px-4 py-2 rounded text-sm"
              onClick={()=>addRow("STAFF")}
            >
              + Add Staff
            </button>
            <button type="button"
              className="bg-rose-800 text-white px-4 py-2 rounded text-sm"
              onClick={()=>addRow("SALES")}
            >
              + Add Sales
            </button>
            <button type="button"
              className="bg-rose-800 text-white px-4 py-2 rounded text-sm"
              onClick={()=>addRow("DISTRIBUTION")}
            >
              + Add Distribution
            </button>
            <button type="button"
              className="bg-rose-800 text-white px-4 py-2 rounded text-sm"
              onClick={()=>addRow("CANS")}
            >
              + Add Cans
            </button>
          </div>

          {/* STAFF */}
          {hasStaff && (
            <section className="bg-white p-4 rounded shadow space-y-1">
              <h2 className="font-semibold mb-1">Staff</h2>
              {rows.map((r,i)=>r.rowType==="STAFF" && (
                <div key={i} className="flex gap-2 items-center">
                  <input list="staff" className="p-2 border rounded flex-1"
                    placeholder="Name"
                    value={r.staffName}
                    onChange={e=>updateRow(i,"staffName",e.target.value)}
                  />
                  <select className="p-2 border rounded"
                    value={r.task}
                    onChange={e=>updateRow(i,"task",e.target.value)}
                  >
                    {TASKS.map(t=><option key={t}>{t}</option>)}
                  </select>
                  <input type="time"
                    className="p-2 border rounded"
                    value={r.startTime}
                    onChange={e=>updateRow(i,"startTime",e.target.value)}
                  />
                  <input type="time"
                    className="p-2 border rounded"
                    value={r.endTime}
                    onChange={e=>updateRow(i,"endTime",e.target.value)}
                  />
                  <button
                    type="button"
                    className="text-red-600 text-xl px-2"
                    onClick={()=>removeRow(i)}
                  >×</button>
                </div>
              ))}
            </section>
          )}

          {/* SALES */}
          {hasSales && (
            <section className="bg-white p-4 rounded shadow space-y-1">
              <h2 className="font-semibold mb-1">Sales</h2>
              
              {/* Total Sales */}
              {rows.map((r,i)=>r.rowType==="SALES" && (
                <div key={i} className="flex gap-2 items-center bg-slate-50 p-2 rounded">
                  <input type="number" step="0.01"
                    className="p-2 border rounded flex-1"
                    placeholder="Total Sales ($)"
                    value={r.totalSales}
                    onChange={e=>updateRow(i,"totalSales",e.target.value)}
                  />
                  <button
                    type="button"
                    className="text-red-600 text-xl px-2"
                    onClick={()=>removeRow(i)}
                  >×</button>
                </div>
              ))}

              {/* Products */}
              {rows.map((r,i)=>r.rowType==="PRODUCT" && (
                <div key={i} className="flex gap-2 items-center">
                  <input list="products"
                    className="p-2 border rounded flex-1"
                    placeholder="Product"
                    value={r.productName}
                    onChange={e=>updateRow(i,"productName",e.target.value)}
                  />
                  <input type="number"
                    className="p-2 border rounded w-24"
                    placeholder="Qty"
                    value={r.quantity}
                    onChange={e=>updateRow(i,"quantity",e.target.value)}
                  />
                  <button
                    type="button"
                    className="text-red-600 text-xl px-2"
                    onClick={()=>removeRow(i)}
                  >×</button>
                </div>
              ))}
              
              <button type="button"
                className="text-rose-800 text-sm mt-1"
                onClick={()=>addRow("PRODUCT")}
              >
                + Add product
              </button>
            </section>
          )}

          {/* DISTRIBUTIONS */}
          {hasDistributions && (
            <section className="bg-white p-4 rounded shadow space-y-1">
              <h2 className="font-semibold mb-1">Distributions</h2>
              {rows.map((r,i)=>r.rowType==="DISTRIBUTION" && (
                <div key={i} className="flex gap-2 items-center">
                  <input type="number"
                    className="p-2 border rounded w-32"
                    placeholder="Bins"
                    value={r.binsDistributed}
                    onChange={e=>updateRow(i,"binsDistributed",e.target.value)}
                  />
                  <input list="distribution-locations"
                    className="p-2 border rounded flex-1"
                    placeholder="Distribution To"
                    value={r.distributionTo}
                    onChange={e=>updateRow(i,"distributionTo",e.target.value)}
                  />
                  <button
                    type="button"
                    className="text-red-600 text-xl px-2"
                    onClick={()=>removeRow(i)}
                  >×</button>
                </div>
              ))}
            </section>
          )}

          {/* CANS */}
          {hasCans && (
            <section className="bg-white p-4 rounded shadow space-y-1">
              <h2 className="font-semibold mb-1">Cans</h2>
              {rows.map((r,i)=>r.rowType==="CANS" && (
                <div key={i} className="flex gap-2 items-center">
                  <input type="number" step="0.1"
                    className="p-2 border rounded w-32"
                    placeholder="KG"
                    value={r.cansKg}
                    onChange={e=>updateRow(i,"cansKg",e.target.value)}
                  />
                  <input list="cans-locations"
                    className="p-2 border rounded flex-1"
                    placeholder="Location"
                    value={r.cansLocation}
                    onChange={e=>updateRow(i,"cansLocation",e.target.value)}
                  />
                  <button
                    type="button"
                    className="text-red-600 text-xl px-2"
                    onClick={()=>removeRow(i)}
                  >×</button>
                </div>
              ))}
            </section>
          )}

          <button
            disabled={loading}
            className="w-full bg-rose-900 text-white py-3 rounded text-lg font-semibold disabled:opacity-50"
          >
            {loading ? "Saving…" : "Save Report"}
          </button>

        </form>

      </main>

      <datalist id="products">
        {PRODUCTS.map(p=><option key={p} value={p} />)}
      </datalist>
      <datalist id="staff">
        {STAFF.map(s=><option key={s} value={s} />)}
      </datalist>
      <datalist id="distribution-locations">
        {DISTRIBUTION_LOCATIONS.map(l=><option key={l} value={l} />)}
      </datalist>
      <datalist id="cans-locations">
        {CANS_LOCATIONS.map(l=><option key={l} value={l} />)}
      </datalist>
    </>
  );
}

ReactDOM.render(<App />, document.getElementById("root"));
</script>
</body>
</html>
